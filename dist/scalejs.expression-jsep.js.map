{"version":3,"sources":["../src/scalejs.expression-jsep.js"],"names":[],"mappings":"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","file":"scalejs.expression-jsep.js","sourcesContent":["import core from 'scalejs.core';\r\nimport jsep from 'jsep';\r\nimport ko from 'knockout';\r\n    \r\n\r\n    var is = core.type.is;\r\n\r\n    function getIdentifiers(term) {\r\n        // TODO: error checking for poorly formatted expressions\r\n        try {\r\n            var parseTree = jsep(term);\r\n        } catch (ex) {\r\n            console.warn('Left term is poorly formatted: ' + term);\r\n            return [];\r\n        }\r\n\r\n        var ids = [];\r\n        //console.log(parseTree);\r\n        function collectIds(tree) {\r\n            Object.keys(tree).forEach(function (key) {\r\n                if (key === 'left' || key === 'right' || key === 'argument') {\r\n                    if (tree[key].type === 'Identifier') {\r\n                        // check for uniqueness o f idntifier\r\n                        if (ids.indexOf(tree[key].name) === -1) {\r\n                            ids.push(tree[key].name);\r\n                        }\r\n                    } else {\r\n                        collectIds(tree[key]);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        collectIds(parseTree);\r\n        return ids;\r\n    }\r\n\r\n    function evaluate(term, mapFunc, opts) {\r\n\r\n        opts = opts || { };\r\n        opts.binary = opts.binary || { };\r\n        opts.unary = opts.unary || { };\r\n\r\n        Object.keys(opts.binary).forEach(function (op) {\r\n            jsep.addBinaryOp(op, 10);\r\n        });\r\n        Object.keys(opts.unary).forEach(function (op) {\r\n            jsep.addUnaryOp(op);\r\n        });\r\n\r\n        var parseTree;\r\n        try {\r\n            parseTree = jsep(term);\r\n        } catch (ex) {\r\n            console.error('error evaluating expr: ' + term, ex);\r\n            return '';\r\n        }\r\n\r\n        Object.keys(opts.binary).forEach(function (op) {\r\n            jsep.removeBinaryOp(op);\r\n        });\r\n        Object.keys(opts.unary).forEach(function (op) {\r\n            jsep.removeUnaryOp(op);\r\n        });\r\n\r\n\r\n        function expr(tree) {\r\n            var returnVal,\r\n                left,\r\n                right;\r\n\r\n            switch (tree.type) {\r\n                case 'BinaryExpression':\r\n                    left = expr(tree.left);\r\n                    right = expr(tree.right);\r\n\r\n                    left =  left === 'true'  || left === true ? true :\r\n                            left === 'false' || left === false ? false :\r\n                           left === '' || left === null ? '\"\"' :\r\n                            left === 'undefined' || left === undefined ? undefined :\r\n                            isFinite(Number(left)) ? Number(left) :\r\n                            typeof left === 'object' ? JSON.stringify(left) :\r\n                            '\"' + left + '\"';\r\n                    right = right === 'true' || right === true ? true :\r\n                            right === 'false' || right === false ? false :\r\n                            right === '' || right === null ? '\"\"' :\r\n                            right === 'undefined' || right === undefined ? undefined :\r\n                            isFinite(Number(right)) ? Number(right) :\r\n                            typeof right === 'object' ? JSON.stringify(right) :\r\n                            '\"' + right + '\"';\r\n\r\n                    tree.left.value = left;\r\n                    tree.right.value = right;\r\n\r\n                    try {\r\n                        if (Object.keys(opts.binary).indexOf(tree.operator) > -1) {\r\n                            returnVal = opts.binary[tree.operator](left, right);\r\n                        } else if (opts.evaluate) {\r\n                            returnVal = opts.evaluate(tree.operator, left, right);\r\n                        } else {\r\n                        returnVal = eval(left + ' ' + tree.operator +  ' ' + right);\r\n                        }\r\n                    } catch (ex) {\r\n                        console.error('error parsing expr:', parseTree, ex);\r\n                        return '';\r\n                    }\r\n                    //console.log('binary:', tree.left.value, tree.operator, tree.right.value, returnVal);\r\n                    return returnVal;\r\n\r\n                case 'UnaryExpression':\r\n                    var value = expr(tree.argument);\r\n                        value =  value === 'true'  || value === true ? true :\r\n                            value === 'false' || value === false ? false :\r\n                           value === '' || value === null ? '\"\"' :\r\n                            value === 'undefined' || value === undefined ? undefined :\r\n                            isFinite(Number(value)) ? Number(value) :\r\n                            typeof value === 'object' ? JSON.stringify(value) :\r\n                            '\"' + value + '\"';\r\n                        tree.argument.value = value;\r\n                    try {\r\n                        if (Object.keys(opts.unary).indexOf(tree.operator) > -1) {\r\n                            returnVal = opts.unary[tree.operator](tree.argument);\r\n                        } else if (opts.evaluate) {\r\n                            returnVal = opts.evaluate(tree.operator, tree.argument);\r\n                        } else {\r\n                    returnVal = eval(tree.operator + tree.argument.value);\r\n                        }\r\n                    } catch (ex) {\r\n                        console.error('error parsing expr:', parseTree, ex);\r\n                        return '';\r\n                    }\r\n                    //console.log('unary:', tree.operator, tree.argument.value, returnVal);\r\n                    return returnVal;\r\n                case 'LogicalExpression':\r\n                    left = expr(tree.left);\r\n                    right = expr(tree.right);\r\n\r\n                    left =  left === 'true'  || left === true ? true :\r\n                            left === 'false' || left === false ? false :\r\n                            left === '' || left === null ? '\"\"' :\r\n                            left === 'undefined' || left === undefined ? undefined :\r\n                            isFinite(Number(left)) ? Number(left) :\r\n                            typeof left === 'object' ? JSON.stringify(left) :\r\n                            '\"' + left + '\"';\r\n                    right = right === 'true' || right === true ? true :\r\n                            right === 'false' || right === false ? false :\r\n                            right === '' || right === null ? '\"\"' :\r\n                            right === 'undefined' || right === undefined ? undefined :\r\n                            isFinite(Number(right)) ? Number(right) :\r\n                            typeof right === 'object' ? JSON.stringify(right) :\r\n                            '\"' + right + '\"';\r\n\r\n                    tree.left.value = left;\r\n                    tree.right.value = right;\r\n\r\n                    try {\r\n                        returnVal = eval(left + tree.operator + right);\r\n                    } catch (ex) {\r\n                        console.error('There was an error when parsing expression', parseTree, ex);\r\n                        return '';\r\n                    }\r\n                    //console.log('Logical Operation:', tree.left.value, tree.operator, tree.right.value, returnVal);\r\n                    return returnVal;\r\n                case 'Identifier':\r\n                    returnVal = mapFunc(tree.name);\r\n                    return returnVal;\r\n                case 'MemberExpression':\r\n                    tree.object = expr(tree.object);\r\n                    // unwrap is used as an object may have observable values..?\r\n                    if (tree.property.type == 'Identifier') {\r\n                        tree.property.value = tree.property.name;\r\n                    } else {\r\n                        tree.property.value = expr(tree.property);\r\n                    }\r\n                    returnVal = ko.unwrap((tree.object||{})[tree.property.value]);\r\n                    return returnVal;\r\n                 case 'CallExpression':\r\n                    returnVal = '';\r\n                    tree.callee = expr(tree.callee);\r\n                    tree.arguments = tree.arguments.map(function (arg) {\r\n                        return expr(arg);\r\n                    });\r\n                    if(tree.callee instanceof Function) {\r\n                        returnVal = tree.callee.apply(this, tree.arguments);\r\n                    }\r\n                    return returnVal;\r\n                case 'ArrayExpression':\r\n                    returnVal = tree.elements.map(function (arg) {\r\n                        return expr(arg);\r\n                    });\r\n                    return returnVal;\r\n                default:\r\n                    return tree.value;\r\n            }\r\n        }\r\n\r\n        return expr(parseTree);\r\n    }\r\n\r\n    core.registerExtension({\r\n        expression: {\r\n            getIdentifiers: getIdentifiers,\r\n            evaluate: evaluate\r\n        }\r\n    });\r\n\r\n    export {\r\n        getIdentifiers,\r\n        evaluate\r\n    }\r\n\r\n"]}